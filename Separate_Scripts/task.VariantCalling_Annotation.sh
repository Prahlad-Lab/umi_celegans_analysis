#!/bin/bash -l
#
#SBATCH --nodes=1
#SBATCH --ntasks-per-node=1
#SBATCH --cpus-per-task=16
#SBATCH --job-name="VariantCalling_Annotation"
#SBATCH --output=stdout/task.VariantCalling_Annotation.out
#SBATCH --mail-user=Johnny.CruzCorchado@RoswellPark.org
#SBATCH --mail-type=begin,end
#SBATCH --partition=general-compute
#SBATCH --qos=general-compute
#SBATCH --cluster=ub-hpc
#SBATCH --mem=100G

# --- Define Directories ---
vcf_dir="/vscratch/grp-vprahlad/umi_analysis/data/input"
input_dir="/projects/rpci/vprahlad/umi_celegans/data/input"
hap_caller_dir="/vscratch/grp-vprahlad/umi_analysis/data/output_broad/Family_size1_haplotype_caller"
snpeff_dir="/vscratch/grp-vprahlad/umi_analysis/data/output_broad/Family_size1_annotation"

# --- Reference Files ---
REFERENCE_FASTA="/projects/rpci/vprahlad/umi_celegans/data/input/Caenorhabditis_elegans.WBcel235.dna.toplevel.fa"
DBSNP_VCF="${vcf_dir}/CB4856.hard-filter.vcf.gz"

# --- Prepare output directories ---
if [ ! -d $hap_caller_dir ]; then
    mkdir -p ${hap_caller_dir}
fi
if [ ! -d $snpeff_dir ]; then
    mkdir -p ${snpeff_dir}
fi

# --- Sample List (Combined from both scripts) ---
sample=("N2.30min.HS.1" "N2.30min.HS.2" "N2.30min.HS.3" "PRDE1.30min.HS.1" "PRDE1.30min.HS.2" "PRDE1.30min.HS.3")

# ---
# STEP 1: Run HaplotypeCaller for ALL samples
# ---
echo "--- Starting Step 1: HaplotypeCaller for all samples ---"
conda activate gatk4
for i in ${sample[@]}
do
    echo "Step 1 - Processing sample: ${i}"
    # Haplotype Caller for RNA-seq variant calling
    gatk HaplotypeCaller \
        -R ${REFERENCE_FASTA} \
        -I ${hap_caller_dir}/"${i}".singletons.BSQR.bam \
        --dont-use-soft-clipped-bases true \
        -O ${hap_caller_dir}/"${i}".singletons.first.vcf.gz \
        --standard-min-confidence-threshold-for-calling 20 \
        --dbsnp ${DBSNP_VCF}
done
echo "--- Completed Step 1 for all samples. ---"


# ---
# STEP 2: Run SnpEff for ALL samples
# ---
echo "--- Starting Step 2: SnpEff Annotation for all samples ---"
conda activate snpeff
for i in ${sample[@]}
do
    echo "Step 2 - Annotating sample: ${i}"
    # Annotate the VCF file generated by HaplotypeCaller
    snpEff WBcel235.105 -stats ${snpeff_dir}/"${i}"_singleton_summary.html ${hap_caller_dir}/"${i}".singletons.first.vcf.gz > ${snpeff_dir}/"${i}".singletons.ann.vcf

    # Generate additional BED annotation and CSV stats
    snpEff ann WBcel235.105 -csvStats ${snpeff_dir}/"${i}"_singletons_summary.csv -o bedANN ${hap_caller_dir}/"${i}".singletons.first.vcf.gz  > ${snpeff_dir}/"${i}".singletons.ann.bed
done
echo "--- Completed Step 2 for all samples. ---"


echo "All pipeline steps have been successfully processed."
